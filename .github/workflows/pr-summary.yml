name: PR Auto Comment Bot

on:
  pull_request:
    types: [opened]

permissions:
  pull-requests: write
  contents: read

jobs:
  summarize:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
            fetch-depth: 0
      - name: Generate PR summary
        id: generate
        run: |
          echo "### ðŸ“¦ PRæ¦‚è¦" > summary.txt
          echo "${{ github.event.pull_request.title }}" >> summary.txt
          echo "" >> summary.txt

          echo "### ðŸ§­ å¤‰æ›´å†…å®¹ã‚µãƒžãƒªãƒ¼" >> summary.txt
          echo "- ${GITHUB_ACTOR} ã«ã‚ˆã‚‹è‡ªå‹•æŠ•ç¨¿" >> summary.txt
          echo "- å†…å®¹ã¯ãƒ•ã‚¡ã‚¤ãƒ«å·®åˆ†ãƒ™ãƒ¼ã‚¹ã§ã™ï¼ˆè©³ç´°ã¯PRæœ¬æ–‡ã¸è¨˜è¼‰æŽ¨å¥¨ï¼‰" >> summary.txt
          echo "" >> summary.txt

          echo "### ðŸ“ å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§" >> summary.txt
          git diff --name-only origin/${{ github.base_ref }}...HEAD >> summary.txt
          echo "" >> summary.txt

          echo "### ðŸ”§ PR Auto Summary" >> summary.txt
          echo '```' >> summary.txt
          git diff --stat origin/${{ github.base_ref }}...HEAD >> summary.txt
          echo '```' >> summary.txt
          echo "" >> summary.txt

          echo "### ðŸ·ï¸ é–¢é€£Issue" >> summary.txt
          echo "- æŽ¨å®š: $(echo '${{ github.head_ref }}' | grep -Eo '[A-Z]+-[0-9]+' || echo 'ãªã—')" >> summary.txt
          echo "" >> summary.txt

          echo "### âœ… ãƒ†ã‚¹ãƒˆçŠ¶æ³" >> summary.txt
          if git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -qE 'tests/|\.test\.'; then
            echo "- âœ… ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ãŒå¤‰æ›´ã•ã‚Œã¦ã„ã¾ã™" >> summary.txt
          else
            echo "- âš ï¸ ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã¯æ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ" >> summary.txt
          fi
          echo "" >> summary.txt

          echo "### ðŸ’¥ å½±éŸ¿ç¯„å›²ï¼ˆäºˆæ¸¬ï¼‰" >> summary.txt
          FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD)
          echo "- UI: $(echo "$FILES" | grep -q 'components/' && echo 'âœ…' || echo 'âŒ')" >> summary.txt
          echo "- ãƒ­ã‚¸ãƒƒã‚¯: $(echo "$FILES" | grep -q 'utils/' && echo 'âœ…' || echo 'âŒ')" >> summary.txt
          echo "- ãƒ†ã‚¹ãƒˆ: $(echo "$FILES" | grep -qE 'tests/|\.test\.' && echo 'âœ…' || echo 'âŒ')" >> summary.txt
          echo "- DB: $(echo "$FILES" | grep -q 'migrations/' && echo 'âœ…' || echo 'âŒ')" >> summary.txt
          echo "" >> summary.txt

          echo "### ðŸ”€ ãƒžãƒ¼ã‚¸å…ˆãƒ–ãƒ©ãƒ³ãƒ" >> summary.txt
          echo "- ${{ github.base_ref }} â† ${{ github.head_ref }}" >> summary.txt
          echo "" >> summary.txt

      - name: Post summary comment
        uses: peter-evans/create-or-update-comment@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ github.event.pull_request.number }}
          body-path: summary.txt
